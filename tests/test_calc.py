"""Tests for `calc` module."""
import numpy as np
import pytest

from gridlib import calc


def test_transmat():
    """Test the working of the transmat function."""
    time = np.array([1, 2, 3])
    k = np.array([4, 5])
    result_desired = np.array(
        [
            [1.83156389e-02, 6.73794700e-03],
            [3.35462628e-04, 4.53999298e-05],
            [6.14421235e-06, 3.05902321e-07],
        ],
        dtype=np.float64,
    )

    result = calc.transmat(time, k)

    assert result.shape == (3, 2)
    np.testing.assert_allclose(
        result,
        result_desired,
        err_msg="The result is not equal to the desired \
                                result.",
    )


def test_gradh():
    """Test the working of the 'gradh()' function.

    To easily format copied MATLAB array in Python:
    search regex: '(-*\d+.\d+)\s+'
    replace regex: '$1, '
    """  # noqa: W605
    desired = np.array(
        [
            17.8816621265721,
            17.7050225193318,
            17.4202253936142,
            16.9630600942133,
            16.2343965201810,
            15.0861932289679,
            13.3096660887836,
            10.6394765056533,
            6.80355312172130,
            1.65978134224091,
            -4.57561204574762,
            -11.1472191710871,
            -16.9062310086701,
            -20.7946160543542,
            -22.1880695586691,
            -20.9012904542050,
            -17.1644703019353,
            -11.7566470296533,
            -6.15439589741157,
            -2.11448541954634,
        ],
        dtype=np.float64,
    )

    eq0 = np.array(
        [
            0,
            0.169899419300423,
            0.282264407157606,
            0.351758138398118,
            0.384490230583872,
            0.416560423005266,
            0.428519499201710,
            0.443671108348141,
            0.455110626017612,
            0.464356283140398,
            0.458263327949987,
            0.463375288876816,
            0.464801214103161,
            0.465190847101989,
            0.464450666402338,
            0.459738675310427,
            0.457442239925233,
            0.455663841757219,
            0.451592317679050,
            0.447952932960381,
            0.439181311894706,
            0.431699011884256,
            0.427322932754184,
            0.423264735086274,
            0.418581984285493,
            0.415099428181554,
            0.410957071246780,
            0.404296551852469,
            0.398790880752459,
            0.393506011617294,
            0.386587324602241,
            0.382632768934745,
            0.378867867801207,
            0.372518895629096,
            0.369107727440706,
            0.362175270593582,
            0.357244537082358,
            0.353387410281071,
            0.347832892973704,
            0.345183655979310,
            0.338982822047705,
            0.333833749326613,
            0.330653458993225,
            0.326672609796203,
            0.321887088225810,
            0.319057988159575,
            0.315416661715493,
            0.311881292672176,
            0.307526927721831,
            0.302350440022293,
            0.298192176037320,
            0.294127649579050,
            0.290154167722095,
            0.286269162675328,
            0.282470183434267,
            0.278754888145256,
            0.274199378122584,
            0.270644827371454,
            0.267167522767496,
            0.265608812538449,
            0.261358511390514,
            0.257179780672887,
            0.253992534236326,
            0.253638411428833,
            0.250585842545779,
            0.247598248183782,
            0.247439105194472,
            0.243655353872018,
            0.240853892899772,
            0.237190056048559,
            0.234505858630004,
            0.231878382354859,
            0.229306409183044,
            0.226788760375389,
            0.224324294653912,
            0.221911906475193,
            0.218628865422182,
            0.216317450623780,
            0.213133336416328,
            0.209997203894910,
            0.206908103694197,
            0.203865113772184,
            0.200867338274800,
            0.198835565449162,
            0.196847289670374,
            0.193980028453580,
            0.191154639516805,
            0.188370342960417,
            0.186548038421901,
            0.183843668355202,
            0.182099830197014,
            0.180394162763195,
            0.178725981527466,
            0.177094619001504,
            0.175499424131540,
            0.174861420709674,
            0.172415011895014,
            0.170002910566565,
            0.167624525921193,
            0.165279280969663,
            0.162966612081587,
            0.160685968550429,
            0.158436812177492,
            0.156218616873835,
            0.154030868279166,
            0.151873063396819,
            0.150666369230114,
            0.148566986502293,
            0.146496103251888,
            0.145374917565503,
            0.143359660322936,
            0.142293207815765,
            0.140331809584441,
            0.139318360044784,
            0.137409126345739,
            0.135525361029361,
            0.133666665851999,
        ],
        dtype=np.float64,
    )
    q = np.array(
        [
            0.990049833749168,
            0.980198673306755,
            0.970445533548508,
            0.960789439152323,
            0.951229424500714,
            0.941764533584249,
            0.932393819905948,
            0.923116346386636,
            0.913931185271228,
            0.904837418035960,
            0.895834135296528,
            0.886920436717158,
            0.878095430920561,
            0.869358235398806,
            0.860707976425058,
            0.852143788966211,
            0.843664816596384,
            0.835270211411272,
            0.826959133943362,
            0.818730753077982,
            0.810584245970187,
            0.802518797962479,
            0.794533602503334,
            0.786627861066553,
            0.778800783071405,
            0.771051585803566,
            0.763379494336853,
            0.755783741455726,
            0.748263567578565,
            0.740818220681718,
            0.733446956224289,
            0.726149037073691,
            0.718923733431926,
            0.711770322762610,
            0.704688089718713,
            0.697676326071031,
            0.690734330637355,
            0.683861409212356,
            0.677056874498165,
            0.670320046035639,
            0.663650250136319,
            0.657046819815057,
            0.650509094723317,
            0.644036421083141,
            0.637628151621773,
            0.631283645506926,
            0.625002268282701,
            0.618783391806141,
            0.612626394184416,
            0.606530659712633,
            0.600495578812266,
            0.594520547970194,
            0.588604969678355,
            0.582748252373990,
            0.576949810380487,
            0.571209063848815,
            0.565525438699537,
            0.559898366565402,
            0.554327284734507,
            0.548811636094027,
            0.543350869074500,
            0.537944437594675,
            0.532591801006897,
            0.527292424043049,
            0.522045776761016,
            0.516851334491699,
            0.511708577786542,
            0.506616992365590,
            0.501576069066056,
            0.496585303791409,
            0.491644197460965,
            0.486752255959972,
            0.481908990090202,
            0.477113915521034,
            0.472366552741015,
            0.467666427009909,
            0.463013068311228,
            0.458406011305224,
            0.453844795282356,
            0.449328964117222,
            0.444858066222941,
            0.440431654505999,
            0.436049286321536,
            0.431710523429080,
            0.427414931948727,
            0.423162082317749,
            0.418951549247639,
            0.414782911681581,
            0.410655752752345,
            0.406569659740599,
            0.402524224033636,
            0.398519041084514,
            0.394553710371601,
            0.390627835358521,
            0.386741023454501,
            0.382892885975112,
            0.379083038103399,
            0.375311098851400,
            0.371576691022046,
            0.367879441171442,
            0.364218979571523,
            0.360594940173078,
            0.357006960569147,
            0.353454681958780,
            0.349937749111155,
            0.346455810330057,
            0.343008517418707,
            0.339595525644939,
            0.336216493706733,
            0.332871083698080,
            0.329558961075189,
            0.326279794623039,
            0.323033256422253,
            0.319819021816304,
            0.316636769379053,
            0.313486180882605,
            0.310366941265485,
        ],
        dtype=np.float64,
    )
    h = np.array(
        [
            0.808723953097941,
            0.767419712146704,
            0.737807710632337,
            0.714807863841434,
            0.696014056081900,
            0.680125464999133,
            0.666363600886919,
            0.654226094232056,
            0.643369906299492,
            0.633550359180004,
            0.624586791214908,
            0.616342005652696,
            0.608709357277006,
            0.601604304894144,
            0.594958695559003,
            0.588716784593766,
            0.582832394951982,
            0.577266845675781,
            0.571987412360495,
            0.566966163642206,
            0.562179068600570,
            0.557605302728531,
            0.553226701708431,
            0.549027326759631,
            0.544993115282392,
            0.541111597470540,
            0.537371664488946,
            0.533763377351915,
            0.530277808217885,
            0.526906907718368,
            0.523643393358211,
            0.520480655094074,
            0.517412675012162,
            0.514433958651578,
            0.511539476003924,
            0.508724610597776,
            0.505985115373998,
            0.503317074293247,
            0.500716868804765,
            0.498181148456101,
            0.495706805044968,
            0.493290949813067,
            0.490930893262186,
            0.488624127238930,
            0.486368308988814,
            0.484161246925527,
            0.482000887898631,
            0.479885305774237,
            0.477812691169453,
            0.475781342203449,
            0.473789656146670,
            0.471836121865486,
            0.469919312973062,
            0.468037881608662,
            0.466190552777431,
            0.464376119191131,
            0.462593436557537,
            0.460841419272482,
            0.459119036473942,
            0.457425308422247,
            0.455759303174616,
            0.454120133525748,
            0.452506954189338,
            0.450918959198103,
            0.449355379502312,
            0.447815480748893,
            0.446298561225083,
            0.444803949952197,
            0.443331004916562,
            0.441879111425939,
            0.440447680580898,
            0.439036147851639,
            0.437643971751642,
            0.436270632600346,
            0.434915631367795,
            0.433578488594797,
            0.432258743382761,
            0.430955952447898,
            0.429669689234894,
            0.428399543085652,
            0.427145118459035,
            0.425906034197898,
            0.424681922840009,
            0.423472429969758,
            0.422277213607765,
            0.421095943635779,
            0.419928301254440,
            0.418773978471673,
            0.417632677619665,
            0.416504110898524,
            0.415387999944883,
            0.414284075423812,
            0.413192076642561,
            0.412111751184728,
            0.411042854563598,
            0.409985149893422,
            0.408938407577572,
            0.407902405012515,
            0.406876926306665,
            0.405861762013223,
            0.404856708876181,
            0.403861569588710,
            0.402876152563227,
            0.401900271712458,
            0.400933746240886,
            0.399976400445980,
            0.399028063528681,
            0.398088569412612,
            0.397157756571555,
            0.396235467864724,
            0.395321550379433,
            0.394415855280755,
            0.393518237667806,
            0.392628556436304,
            0.391746674147076,
            0.390872456900218,
            0.390005774214599,
        ],
        dtype=np.float64,
    )
    time = np.array(
        [
            0.28,
            0.42,
            0.56,
            0.7,
            0.84,
            0.98,
            1.12,
            1.26,
            1.4,
            1.54,
            1.68,
            1.82,
            1.96,
            2.1,
            2.24,
            2.38,
            2.52,
            2.66,
            2.8,
            2.94,
            3.08,
            3.22,
            3.36,
            3.5,
            3.64,
            3.78,
            3.92,
            4.06,
            4.2,
            4.34,
            4.48,
            4.62,
            4.76,
            4.9,
            5.04,
            5.18,
            5.32,
            5.46,
            5.6,
            5.74,
            5.88,
            6.02,
            6.16,
            6.3,
            6.44,
            6.58,
            6.72,
            6.86,
            7,
            7.14,
            7.28,
            7.42,
            7.56,
            7.7,
            7.84,
            7.98,
            8.12,
            8.26,
            8.4,
            8.54,
            8.68,
            8.82,
            8.96,
            9.1,
            9.24,
            9.38,
            9.52,
            9.66,
            9.8,
            9.94,
            10.08,
            10.22,
            10.36,
            10.5,
            10.64,
            10.78,
            10.92,
            11.06,
            11.2,
            11.34,
            11.48,
            11.62,
            11.76,
            11.9,
            12.04,
            12.18,
            12.32,
            12.46,
            12.6,
            12.74,
            12.88,
            13.02,
            13.16,
            13.3,
            13.44,
            13.58,
            13.72,
            13.86,
            14,
            14.14,
            14.28,
            14.42,
            14.56,
            14.7,
            14.84,
            14.98,
            15.12,
            15.26,
            15.4,
            15.54,
            15.68,
            15.82,
            15.96,
            16.1,
            16.24,
            16.38,
            16.52,
        ],
        dtype=np.float64,
    )
    k = np.array(
        [
            0.00100000000000000,
            0.00162377673918872,
            0.00263665089873036,
            0.00428133239871940,
            0.00695192796177561,
            0.0112883789168469,
            0.0183298071083244,
            0.0297635144163132,
            0.0483293023857175,
            0.0784759970351461,
            0.127427498570313,
            0.206913808111479,
            0.335981828628378,
            0.545559478116852,
            0.885866790410082,
            1.43844988828766,
            2.33572146909012,
            3.79269019073225,
            6.15848211066026,
            10,
        ],
        dtype=np.float64,
    )

    result = calc.gradh(eq0, q, h, time, k)
    np.testing.assert_allclose(
        result,
        desired,
        err_msg="The result is not equal to the desired \
                                result.",
    )


def test_gradq():
    """Test the working of the 'gradq()' function."""
    desired = -9.500024528524474e02

    eq0 = np.array(
        [
            0,
            0.169899419300423,
            0.282264407157606,
            0.351758138398118,
            0.384490230583872,
            0.416560423005266,
            0.428519499201710,
            0.443671108348141,
            0.455110626017612,
            0.464356283140398,
            0.458263327949987,
            0.463375288876816,
            0.464801214103161,
            0.465190847101989,
            0.464450666402338,
            0.459738675310427,
            0.457442239925233,
            0.455663841757219,
            0.451592317679050,
            0.447952932960381,
            0.439181311894706,
            0.431699011884256,
            0.427322932754184,
            0.423264735086274,
            0.418581984285493,
            0.415099428181554,
            0.410957071246780,
            0.404296551852469,
            0.398790880752459,
            0.393506011617294,
            0.386587324602241,
            0.382632768934745,
            0.378867867801207,
            0.372518895629096,
            0.369107727440706,
            0.362175270593582,
            0.357244537082358,
            0.353387410281071,
            0.347832892973704,
            0.345183655979310,
            0.338982822047705,
            0.333833749326613,
            0.330653458993225,
            0.326672609796203,
            0.321887088225810,
            0.319057988159575,
            0.315416661715493,
            0.311881292672176,
            0.307526927721831,
            0.302350440022293,
            0.298192176037320,
            0.294127649579050,
            0.290154167722095,
            0.286269162675328,
            0.282470183434267,
            0.278754888145256,
            0.274199378122584,
            0.270644827371454,
            0.267167522767496,
            0.265608812538449,
            0.261358511390514,
            0.257179780672887,
            0.253992534236326,
            0.253638411428833,
            0.250585842545779,
            0.247598248183782,
            0.247439105194472,
            0.243655353872018,
            0.240853892899772,
            0.237190056048559,
            0.234505858630004,
            0.231878382354859,
            0.229306409183044,
            0.226788760375389,
            0.224324294653912,
            0.221911906475193,
            0.218628865422182,
            0.216317450623780,
            0.213133336416328,
            0.209997203894910,
            0.206908103694197,
            0.203865113772184,
            0.200867338274800,
            0.198835565449162,
            0.196847289670374,
            0.193980028453580,
            0.191154639516805,
            0.188370342960417,
            0.186548038421901,
            0.183843668355202,
            0.182099830197014,
            0.180394162763195,
            0.178725981527466,
            0.177094619001504,
            0.175499424131540,
            0.174861420709674,
            0.172415011895014,
            0.170002910566565,
            0.167624525921193,
            0.165279280969663,
            0.162966612081587,
            0.160685968550429,
            0.158436812177492,
            0.156218616873835,
            0.154030868279166,
            0.151873063396819,
            0.150666369230114,
            0.148566986502293,
            0.146496103251888,
            0.145374917565503,
            0.143359660322936,
            0.142293207815765,
            0.140331809584441,
            0.139318360044784,
            0.137409126345739,
            0.135525361029361,
            0.133666665851999,
        ],
        dtype=np.float64,
    )
    q = np.array(
        [
            0.990049833749168,
            0.980198673306755,
            0.970445533548508,
            0.960789439152323,
            0.951229424500714,
            0.941764533584249,
            0.932393819905948,
            0.923116346386636,
            0.913931185271228,
            0.904837418035960,
            0.895834135296528,
            0.886920436717158,
            0.878095430920561,
            0.869358235398806,
            0.860707976425058,
            0.852143788966211,
            0.843664816596384,
            0.835270211411272,
            0.826959133943362,
            0.818730753077982,
            0.810584245970187,
            0.802518797962479,
            0.794533602503334,
            0.786627861066553,
            0.778800783071405,
            0.771051585803566,
            0.763379494336853,
            0.755783741455726,
            0.748263567578565,
            0.740818220681718,
            0.733446956224289,
            0.726149037073691,
            0.718923733431926,
            0.711770322762610,
            0.704688089718713,
            0.697676326071031,
            0.690734330637355,
            0.683861409212356,
            0.677056874498165,
            0.670320046035639,
            0.663650250136319,
            0.657046819815057,
            0.650509094723317,
            0.644036421083141,
            0.637628151621773,
            0.631283645506926,
            0.625002268282701,
            0.618783391806141,
            0.612626394184416,
            0.606530659712633,
            0.600495578812266,
            0.594520547970194,
            0.588604969678355,
            0.582748252373990,
            0.576949810380487,
            0.571209063848815,
            0.565525438699537,
            0.559898366565402,
            0.554327284734507,
            0.548811636094027,
            0.543350869074500,
            0.537944437594675,
            0.532591801006897,
            0.527292424043049,
            0.522045776761016,
            0.516851334491699,
            0.511708577786542,
            0.506616992365590,
            0.501576069066056,
            0.496585303791409,
            0.491644197460965,
            0.486752255959972,
            0.481908990090202,
            0.477113915521034,
            0.472366552741015,
            0.467666427009909,
            0.463013068311228,
            0.458406011305224,
            0.453844795282356,
            0.449328964117222,
            0.444858066222941,
            0.440431654505999,
            0.436049286321536,
            0.431710523429080,
            0.427414931948727,
            0.423162082317749,
            0.418951549247639,
            0.414782911681581,
            0.410655752752345,
            0.406569659740599,
            0.402524224033636,
            0.398519041084514,
            0.394553710371601,
            0.390627835358521,
            0.386741023454501,
            0.382892885975112,
            0.379083038103399,
            0.375311098851400,
            0.371576691022046,
            0.367879441171442,
            0.364218979571523,
            0.360594940173078,
            0.357006960569147,
            0.353454681958780,
            0.349937749111155,
            0.346455810330057,
            0.343008517418707,
            0.339595525644939,
            0.336216493706733,
            0.332871083698080,
            0.329558961075189,
            0.326279794623039,
            0.323033256422253,
            0.319819021816304,
            0.316636769379053,
            0.313486180882605,
            0.310366941265485,
        ],
        dtype=np.float64,
    )
    h = np.array(
        [
            0.808723953097941,
            0.767419712146704,
            0.737807710632337,
            0.714807863841434,
            0.696014056081900,
            0.680125464999133,
            0.666363600886919,
            0.654226094232056,
            0.643369906299492,
            0.633550359180004,
            0.624586791214908,
            0.616342005652696,
            0.608709357277006,
            0.601604304894144,
            0.594958695559003,
            0.588716784593766,
            0.582832394951982,
            0.577266845675781,
            0.571987412360495,
            0.566966163642206,
            0.562179068600570,
            0.557605302728531,
            0.553226701708431,
            0.549027326759631,
            0.544993115282392,
            0.541111597470540,
            0.537371664488946,
            0.533763377351915,
            0.530277808217885,
            0.526906907718368,
            0.523643393358211,
            0.520480655094074,
            0.517412675012162,
            0.514433958651578,
            0.511539476003924,
            0.508724610597776,
            0.505985115373998,
            0.503317074293247,
            0.500716868804765,
            0.498181148456101,
            0.495706805044968,
            0.493290949813067,
            0.490930893262186,
            0.488624127238930,
            0.486368308988814,
            0.484161246925527,
            0.482000887898631,
            0.479885305774237,
            0.477812691169453,
            0.475781342203449,
            0.473789656146670,
            0.471836121865486,
            0.469919312973062,
            0.468037881608662,
            0.466190552777431,
            0.464376119191131,
            0.462593436557537,
            0.460841419272482,
            0.459119036473942,
            0.457425308422247,
            0.455759303174616,
            0.454120133525748,
            0.452506954189338,
            0.450918959198103,
            0.449355379502312,
            0.447815480748893,
            0.446298561225083,
            0.444803949952197,
            0.443331004916562,
            0.441879111425939,
            0.440447680580898,
            0.439036147851639,
            0.437643971751642,
            0.436270632600346,
            0.434915631367795,
            0.433578488594797,
            0.432258743382761,
            0.430955952447898,
            0.429669689234894,
            0.428399543085652,
            0.427145118459035,
            0.425906034197898,
            0.424681922840009,
            0.423472429969758,
            0.422277213607765,
            0.421095943635779,
            0.419928301254440,
            0.418773978471673,
            0.417632677619665,
            0.416504110898524,
            0.415387999944883,
            0.414284075423812,
            0.413192076642561,
            0.412111751184728,
            0.411042854563598,
            0.409985149893422,
            0.408938407577572,
            0.407902405012515,
            0.406876926306665,
            0.405861762013223,
            0.404856708876181,
            0.403861569588710,
            0.402876152563227,
            0.401900271712458,
            0.400933746240886,
            0.399976400445980,
            0.399028063528681,
            0.398088569412612,
            0.397157756571555,
            0.396235467864724,
            0.395321550379433,
            0.394415855280755,
            0.393518237667806,
            0.392628556436304,
            0.391746674147076,
            0.390872456900218,
            0.390005774214599,
        ],
        dtype=np.float64,
    )
    time = np.array(
        [
            0.28,
            0.42,
            0.56,
            0.7,
            0.84,
            0.98,
            1.12,
            1.26,
            1.4,
            1.54,
            1.68,
            1.82,
            1.96,
            2.1,
            2.24,
            2.38,
            2.52,
            2.66,
            2.8,
            2.94,
            3.08,
            3.22,
            3.36,
            3.5,
            3.64,
            3.78,
            3.92,
            4.06,
            4.2,
            4.34,
            4.48,
            4.62,
            4.76,
            4.9,
            5.04,
            5.18,
            5.32,
            5.46,
            5.6,
            5.74,
            5.88,
            6.02,
            6.16,
            6.3,
            6.44,
            6.58,
            6.72,
            6.86,
            7,
            7.14,
            7.28,
            7.42,
            7.56,
            7.7,
            7.84,
            7.98,
            8.12,
            8.26,
            8.4,
            8.54,
            8.68,
            8.82,
            8.96,
            9.1,
            9.24,
            9.38,
            9.52,
            9.66,
            9.8,
            9.94,
            10.08,
            10.22,
            10.36,
            10.5,
            10.64,
            10.78,
            10.92,
            11.06,
            11.2,
            11.34,
            11.48,
            11.62,
            11.76,
            11.9,
            12.04,
            12.18,
            12.32,
            12.46,
            12.6,
            12.74,
            12.88,
            13.02,
            13.16,
            13.3,
            13.44,
            13.58,
            13.72,
            13.86,
            14,
            14.14,
            14.28,
            14.42,
            14.56,
            14.7,
            14.84,
            14.98,
            15.12,
            15.26,
            15.4,
            15.54,
            15.68,
            15.82,
            15.96,
            16.1,
            16.24,
            16.38,
            16.52,
        ],
        dtype=np.float64,
    )
    a = 0.01
    result = calc.gradq(eq0, q, h, time, a)
    assert result == pytest.approx(desired)
